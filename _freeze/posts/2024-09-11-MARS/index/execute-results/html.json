{
  "hash": "4404039d10649b67c31f2f6f29ecfa31",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"MARS models in Stan\"\nauthor: \"Andrew MacDonald\"\ndescription: |\n  Getting an interaction matrix from time series data\ndate: 11 Sept 2024\neditor: source\ncategories: [UdeS, stan]\ndraft: true\neditor_options: \n  chunk_output_type: console\n---\n\n\n\nThe MARS model is really commonly used to infer interaction strength from a time series of population sizes.\n\nhere is it is in R:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nS <- 5\n\nB <- matrix(rnorm(S*S, mean = 0, sd = .2), ncol=S, nrow=S)\ndiag(B) <- runif(S)\nA <- runif(S)\n\nnsteps <- 20\npop_sizes <- matrix(0, nrow = S, ncol = nsteps)\nstart <- rep(20, times = S)\npop_sizes[,1] <- start\n\nfor (i in 2:nsteps){\n  pop_sizes[,i] <- A + B %*% pop_sizes[,i-1]\n}\n\npop_sizes_long <- pop_sizes |> \n  as.data.frame() |> \n  rownames_to_column(var = \"sp\") |> \n  pivot_longer(-sp, names_to = \"time\", values_to = \"abd\") |> \n  mutate(time = parse_number(time))\n\npop_sizes_long |> \n  ggplot(aes(x = time, y = abd, group = sp)) + geom_line()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nlet's run a few different simulations just to see\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsome_simulations <- map_df(1:6,\n                           \\(x) {\n                             S <- 5\n                             \n                             B <- matrix(rnorm(S*S, mean = 0, sd = .2),\n                                         ncol=S,\n                                         nrow=S)\n                             diag(B) <- runif(S)\n                             A <- runif(S)\n                             \n                             nsteps <- 20\n                             pop_sizes <- matrix(0, nrow = S, ncol = nsteps)\n                             start <- rep(20, times = S)\n                             pop_sizes[,1] <- start\n                             \n                             for (i in 2:nsteps){\n                               pop_sizes[,i] <- A + B %*% pop_sizes[,i-1]\n                             }\n                             \n                             pop_sizes_long <- pop_sizes |> \n                               as.data.frame() |> \n                               rownames_to_column(var = \"sp\") |> \n                               pivot_longer(-sp, \n                                            names_to = \"time\", \n                                            values_to = \"abd\") |> \n                               mutate(time = parse_number(time))},\n                           .id = \"sim\")\n\nsome_simulations |> \n  ggplot(aes(x = time, y = abd, group = sp)) + geom_line() + \n  facet_wrap(~sim)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nThe MARS model also allows for some variation to occur at each time step: \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsome_simulations <- map_df(1:6,\n                           \\(x) {\n                             S <- 5\n                             \n                             B <- matrix(rnorm(S*S, mean = 0, sd = .1),\n                                         ncol=S,\n                                         nrow=S)\n                             diag(B) <- runif(S, min = .3, max = .6)\n                             A <- rnorm(S, mean = 2, sd = .2)\n                             \n                             nsteps <- 20\n                             pop_sizes <- matrix(0, nrow = S, ncol = nsteps)\n                             start <- rep(3, times = S)\n                             pop_sizes[,1] <- start\n                             \n                             for (i in 2:nsteps){\n                               pop_sizes[,i] <- A + \n                                 B %*% pop_sizes[,i-1] + \n                                 ## variation at each timestep\n                                 rnorm(S, mean = 0, sd = .1)\n                             }\n                             \n                             pop_sizes_long <- pop_sizes |> \n                               as.data.frame() |> \n                               rownames_to_column(var = \"sp\") |> \n                               pivot_longer(-sp, \n                                            names_to = \"time\", \n                                            values_to = \"abd\") |> \n                               mutate(time = parse_number(time))},\n                           .id = \"sim\")\n\nsome_simulations |> \n  ggplot(aes(x = time, \n             y = exp(abd), \n             group = sp)) + geom_line() + \n  facet_wrap(~sim)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nFinally, the observations around these are poisson variables:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsome_simulations |> \n  mutate(obs_abd = rpois(n = length(abd), lambda = exp(abd))) |> \n  ggplot(aes(x = time, \n             y = obs_abd, \n             group = sp)) + geom_point() + \n  facet_wrap(~sim)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n## write the model in Stan\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(cmdstanr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThis is cmdstanr version 0.8.1.9000\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n- CmdStan path: /home/andrew/software/cmdstan\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n- CmdStan version: 2.34.1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nA newer version of CmdStan is available. See ?install_cmdstan() to install it.\nTo disable this check set option or environment variable cmdstanr_no_ver_check=TRUE.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#|class-output: stan\n#|\nmars_poisson_prior <- cmdstan_model(here::here(\"posts/2024-09-11-MARS/mars_poisson_prior.stan\"))\n\nmars_poisson_prior\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ndata {\n  int<lower=1> S;\n  // number of timepoints NOT including the first week of setup\n  int<lower=2> n_time;\n  array[S*n_time] int<lower=0> abds;\n  vector[S] starting;\n}\nparameters {\n  vector[S*(S-1)] offdiag_B;\n  vector<lower=0,upper=1>[S] diag_B;\n  vector[S] A;\n  matrix[S, n_time] error;\n  real<lower=0> sigma_error;\n}\ntransformed parameters {\n  // make the B matrix\n  matrix[S, S] B;\n\n  for (s in 1:S){\n    B[s, s] = diag_B[s];\n  }\n\n  {\n    int idx; // index for going into the off-diag vector\n    idx = 1;\n\n    // Fill the upper diagonal\n    for (i in 1:(S-1)) {\n      for (j in (i+1):S) {\n        B[i, j] = offdiag_B[idx];\n        idx += 1;\n      }\n    }\n\n    // Fill the lower diagonal\n    for (i in 2:S) {\n      for (j in 1:(i-1)) {\n        B[i, j] = offdiag_B[idx];\n        idx += 1;\n      }\n    }\n  }\n\n  // make the true abds\n  matrix[S, n_time] true_abd;\n  true_abd[,1] = A + B * starting + error[,1];\n  for (t in 2:n_time){\n    true_abd[,t] = A + B * true_abd[,t-1] + error[,t];\n  }\n}\nmodel {\n\n  offdiag_B ~ normal(0, .2);\n  diag_B ~ beta(.6*7, .4*7);\n  A ~ normal(0.2, .2);\n  to_vector(error) ~ normal(0, sigma_error);\n  sigma_error ~ exponential(10);\n\n  // likelihood\n  // abds ~ poisson_log(to_vector(true_abd));\n}\ngenerated quantities{\n  array[n_time, S] int sim_abds;\n\n  for (i in 1:n_time){\n    sim_abds[i,] = poisson_log_rng(true_abd[,i]);\n  }\n}\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmars_poisson_prior_samp <- mars_poisson_prior$sample(data = list(\n  S = 4,\n  n_time = 15,\n  abds = rep(1, times = 4*15),\n  starting = rep(log(20), 4)),\n  chains = 1,\n  iter_sampling = 500\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRunning MCMC with 1 chain...\n\nChain 1 Iteration:    1 / 1500 [  0%]  (Warmup) \nChain 1 Iteration:  100 / 1500 [  6%]  (Warmup) \nChain 1 Iteration:  200 / 1500 [ 13%]  (Warmup) \nChain 1 Iteration:  300 / 1500 [ 20%]  (Warmup) \nChain 1 Iteration:  400 / 1500 [ 26%]  (Warmup) \nChain 1 Iteration:  500 / 1500 [ 33%]  (Warmup) \nChain 1 Iteration:  600 / 1500 [ 40%]  (Warmup) \nChain 1 Iteration:  700 / 1500 [ 46%]  (Warmup) \nChain 1 Iteration:  800 / 1500 [ 53%]  (Warmup) \nChain 1 Iteration:  900 / 1500 [ 60%]  (Warmup) \nChain 1 Iteration: 1000 / 1500 [ 66%]  (Warmup) \nChain 1 Iteration: 1001 / 1500 [ 66%]  (Sampling) \nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 21.9629, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 21.9629, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 21.3356, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 21.3356, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 21.8943, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 21.8943, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 21.8778, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 21.8778, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[1] is 22.5174, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[1] is 22.5174, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 21.6144, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 21.6144, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Iteration: 1100 / 1500 [ 73%]  (Sampling) \nChain 1 Exception: poisson_log_rng: Log rate parameter[1] is 21.3019, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[1] is 21.3019, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 23.2795, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 23.2795, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[3] is 24.179, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[3] is 24.179, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 26.9012, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 26.9012, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Iteration: 1200 / 1500 [ 80%]  (Sampling) \nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 24.1329, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 24.1329, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 22.679, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 22.679, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 23.3159, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 23.3159, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 22.1738, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 22.1738, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 21.1828, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[4] is 21.1828, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Iteration: 1300 / 1500 [ 86%]  (Sampling) \nChain 1 Exception: poisson_log_rng: Log rate parameter[1] is 21.0743, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[1] is 21.0743, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[1] is 23.965, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[1] is 23.965, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 22.0748, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49) \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChain 1 Exception: poisson_log_rng: Log rate parameter[2] is 22.0748, but must be less than 20.794415 (in '/tmp/RtmpDijQKC/model-710019bf0eaf.stan', line 66, column 4 to column 49)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChain 1 Iteration: 1400 / 1500 [ 93%]  (Sampling) \nChain 1 Iteration: 1500 / 1500 [100%]  (Sampling) \nChain 1 finished in 1.7 seconds.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: 1 of 1 chains had an E-BFMI less than 0.3.\nSee https://mc-stan.org/misc/warnings for details.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidybayes)\nmars_poisson_prior_samp$draws() |> \n  gather_draws(sim_abds[time, sp], ndraws = 12) |> \n  ggplot(aes(x = time, y = .value, group = sp)) + geom_point() + \n  facet_wrap(~.draw, scales = \"free_y\", ncol = 4)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 60 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidybayes)\nmars_poisson_prior_samp$draws() |> \n  gather_draws(true_abd[sp, time], ndraws = 12) |> \n  ggplot(aes(x = time, y = exp(.value), group = sp)) + \n  geom_line() + \n  facet_wrap(~.draw, scales = \"free_y\", ncol = 4)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}