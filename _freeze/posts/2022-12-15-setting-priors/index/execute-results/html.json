{
  "hash": "952783920f6b0b3b9a37edc7d1e0a360",
  "result": {
    "markdown": "---\ntitle: \"Setting priors on hierarchical multivariate models\"\nauthor: \"Andrew MacDonald\"\ndescription: |\n  keep it realistic.\ndate: 11 Nov 2022\ncategories: [UdeS, stan]\nexecute: \n  eval: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(targets)\nlibrary(ggplot2)\nlibrary(tidyverse)\nlibrary(tidybayes)\n```\n:::\n\n\n## What is this post\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemo_data <- structure(list(csize = c(5, 5, 5), \n                            age_morpho_indic = c(1, 1, \n1), mass = c(20.64, 25.58, 20.2), log_mass = c(3.02723094061336, \n3.2418107961507, 3.00568260440716), dponte = c(134, 135, 136), \n    annee = c(2005, 2006, 2005), ferme = c(9, 9, 9), idF1 = c(188197003, \n    188197004, 188197004), general_csize = c(8.972, 9.344, 8.972\n    ), coldsnap_csize = c(3.9, 7.15, 3.9), general_dponte = c(8.704651163, \n    10.48604651, 8.704651163), coldsnap_dponte = c(2.3, 4.7, \n    2.3), density_TRSW = c(8, 9, 8), density_HOSP = c(0, 0, 0\n    ), paysa_ext = c(0.224174146, 0.223943415, 0.224166189), \n    general_mean_csize = c(-0.482520728753587, -0.343044978530785, \n    -0.343044978530785), difference_general_csize = c(0, 0.186, \n    -0.186), coldsnap_mean_csize = c(-1.09248466640163, -0.156587649057671, \n    -0.156587649057671), difference_coldsnap_csize = c(0, 1.625, \n    -1.625), general_mean_dponte = c(-2.54912170305933, -1.57828050221117, \n    -1.57828050221117), difference_general_dponte = c(0, 0.890698, \n    -0.890698), coldsnap_mean_dponte = c(-1.63910623622377, -0.951828417972457, \n    -0.951828417972457), difference_coldsnap_dponte = c(0, 1.2, \n    -1.2), density_TRSW_mean = c(0.248353096875404, 0.484967912059555, \n    0.484967912059555), difference_density_TRSW = c(0, 0.5, -0.5\n    ), paysa_ext_mean = c(-0.306307397416911, -0.308050462721618, \n    -0.308050462721618), difference_paysa_ext = c(-0.000913607068423686, \n    -0.0152243604543345, 0.0133971463174872), density_HOSP_mean = c(-0.525930668145508, \n    -0.525930668145508, -0.525930668145508), difference_density_HOSP = c(0, \n    0, 0), noisenvol = c(5, 5, 0)), row.names = c(NA, -3L), class = c(\"tbl_df\", \n\"tbl\", \"data.frame\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(brms)\ndponte_model_bf_2 = bf(dponte ~ 1 + age_morpho_indic + general_mean_dponte + difference_general_dponte + (1|annee) + (1|ferme) + \n                         (1 + difference_general_dponte|f|idF1),\n                       family = gaussian(), center = FALSE)\n\n \n\ncsize_model_bf_2 = bf(csize ~ 1 + age_morpho_indic + general_mean_csize + difference_general_csize + (1|annee) + (1|ferme) + \n                        (1 + difference_general_csize|f|idF1),\n                      family = poisson(), center = FALSE)\n\n \n\nsucess_model_bf_2 = bf(noisenvol ~ 1 + (1|f|idF1) + (1|annee) + (1|ferme),\n                       family = poisson(), center = FALSE)\n\n# combine all three into one model\nfull_model_bf <- dponte_model_bf_2 + csize_model_bf_2 + sucess_model_bf_2\n\nget_prior(full_model_bf, data = demo_data)\n\nfull_model_prior <- c(\n  ## individual level correlations\n  prior(lkj(3), class = \"cor\", group = \"idF1\"),\n  ## clutch size model\n  prior(normal(0,1),    class = \"b\", resp = \"csize\"),\n  # prior(normal(0,1),    class = \"Intercept\", resp = \"csize\"),\n  prior(exponential(1), lb = 0, class = \"sd\", resp = \"csize\"),\n  ## laying date model\n  prior(normal(0,1),    class = \"b\",         resp = \"dponte\"),\n  # prior(normal(0,1),    class = \"Intercept\", resp = \"dponte\"),\n  prior(exponential(1), lb = 0, class = \"sd\",   resp = \"dponte\"),\n  prior(exponential(1), lb = 0, class = \"sigma\", resp = \"dponte\"),\n  # fitness -- no slopes here\n  # prior(normal(0,1),    class = \"Intercept\", resp = \"noisenvol\"),\n  prior(exponential(1), lb = 0, class = \"sd\",        resp = \"noisenvol\")\n)\n\n# Run fuul model\nfull_model_prior_predict = brm(full_model_bf,\n                    data = demo_data,\n                    prior = full_model_prior,\n                    cores = 4, chains = 4, \n                    sample_prior = \"only\")\n\n \n\nsummary(full_model_prior_predict)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidybayes)\n\n# noisenvol\nprior_predictions <- demo_data |> \n  add_predicted_rvars(object = full_model_prior_predict, resp = \"noisenvol\")\n\nprior_predictions |> glimpse()\n\nlibrary()\nprior_predictions |> \n  select(idF1, noisenvol, .prediction) |> \n  ungroup() |> \n  ggplot(aes(y = idF1, xdist = .prediction)) + \n  stat_halfeye() + \n  coord_cartesian(xlim =c(0,1e5))\n```\n:::\n\n\nalready we can see that this is probably way too wide!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfull_model_smaller_noisenvol_prior <- c(\n  ## individual level correlations\n  prior(lkj(3), class = \"cor\", group = \"idF1\"),\n  ## clutch size model\n  prior(normal(0,1),    class = \"b\", resp = \"csize\"),\n  prior(exponential(1), lb = 0, class = \"sd\", resp = \"csize\"),\n  ## laying date model\n  prior(normal(138,5),    class = \"b\",         resp = \"dponte\"),\n  prior(exponential(1), lb = 0, class = \"sd\",   resp = \"dponte\"),\n  prior(exponential(1), lb = 0, class = \"sigma\", resp = \"dponte\"),\n  # fitness -- no slopes here\n  prior(normal(1, 0.1),    class = \"b\", resp = \"noisenvol\"),\n  prior(exponential(4), lb = 0, class = \"sd\",        resp = \"noisenvol\")\n)\n\n\n\n# Run fuul model\nfull_model_noisenvol_prior_predict = brm(full_model_bf,\n                    data = demo_data,\n                    prior = full_model_smaller_noisenvol_prior,\n                    cores = 4, chains = 4, \n                    sample_prior = \"only\")\n\n \n\ndemo_data |> \n  add_predicted_rvars(object = full_model_noisenvol_prior_predict, resp = \"noisenvol\") |> \n  select(idF1, noisenvol, .prediction) |> \n  ungroup() |> \n  ggplot(aes(y = idF1, xdist = .prediction)) + \n  stat_halfeye() + \n  coord_cartesian(xlim =c(0,12))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# age_morpho_indic + general_mean_dponte + difference_general_dponte\none_female <- tibble(difference_general_dponte = c(-3,0, 3),\n                     age_morpho_indic = c(0,1,1))\n\nfake_data <- expand_grid(one_female,\n                         nesting(general_mean_dponte = c(-2,0,2),\n                                 idF1 = letters[1:3])) |> \n  arrange(general_mean_dponte) |> \n  mutate(ferme = \"f\",\n         annee = \"y\")\n\ndponte_prior_pred <- fake_data |> \n  add_predicted_draws(object = full_model_noisenvol_prior_predict, \n                      resp = \"dponte\", allow_new_levels = TRUE, ndraws = 3)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndponte_prior_pred |> \n  ggplot(aes(x= difference_general_dponte, y = .prediction, group = .draw)) + \n  geom_line() + \n  facet_wrap(~general_mean_dponte)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}