{
  "hash": "30ca8152c55c231a6a25f90edabaa20a",
  "result": {
    "markdown": "---\ntitle: \"The evolution of plasticity\"\nauthor: \"Andrew MacDonald and Audrey Tremblay\"\ndescription: |\n  How to measure plasticity with a bayesian hierarchical model\ndate: 23 Nov 2022\ncategories: [UdeS, stan, brms, simulation]\nexecute:\n  eval: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\noptions(tidyverse.quiet = TRUE)\nlibrary(targets)\nlibrary(ggplot2)\nlibrary(tidyverse)\nlibrary(tidybayes)\nlibrary(brms)\n\n## functions to make models and so on\nsimulate_many_moms <- function(pop_average_dponte = 138,\n                               pop_average_csize = 4,\n                               mom_quality_max = 4,\n                               quality_on_dponte = 2,\n                               quality_on_csize = .2,\n                               n_females = 42,\n                               lifespan = 5,\n                               temp_range  = c(2, 12)) {\n\n  general_temp <- runif(lifespan, temp_range[1], max = temp_range[2])\n\n  general_temp_c <- general_temp - mean(general_temp)\n\n  mom_qualities <- runif(n_females, min = 0, max = 4)\n\n  many_moms_temperature <- expand_grid(year = 1:lifespan,\n                                       idF1 = 1:n_females) |>\n    mutate(mom_quality = mom_qualities[idF1],\n           general_temp = general_temp[year],\n           general_temp_c = general_temp_c[year],\n           ## adding the biology\n           ## Effect of temperature -- does it depend on quality? let's say that it DOES (for now)\n           effet_temp_dponte_qual = -.7*mom_quality,\n           effet_temp_csize_qual = .1*log(mom_quality),\n           # csize\n           mom_avg_csize = log(pop_average_csize) +  quality_on_csize*log(mom_quality),\n           temp_avg_csize = exp(mom_avg_csize + effet_temp_csize_qual*general_temp_c),\n           # dponte\n           mom_avg_dponte = pop_average_dponte + quality_on_dponte*mom_quality,\n           temp_avg_dponte = mom_avg_dponte + effet_temp_dponte_qual*general_temp_c,\n           ## observations\n           obs_csize = rpois(n = length(year), lambda = temp_avg_csize),\n           obs_dponte = rnorm(n = length(year), mean = temp_avg_dponte, sd = 3) |> round()\n    )\n  return(many_moms_temperature)\n}\n\n\nbrms_dponte_csize <- function(many_moms_temperature) {\n  ## define formulae\n  csize_model_bf <- bf(obs_csize ~ 1 + general_temp_c + (1 + general_temp_c|f|idF1),\n                       family = poisson())\n\n  dponte_model_bf <- bf(obs_dponte ~ 1 + general_temp_c + (1 + general_temp_c|f|idF1),\n                        family = gaussian())\n\n\n  ## set priors\n\n  ## run full model\n  full_model <- brm(csize_model_bf + dponte_model_bf,\n                    data = many_moms_temperature,\n                    cores = 2, chains = 2)\n}\n```\n:::\n\n\n## Study question\n\nPhenotypic plasiticity is the\n\n## Data simulation\n\nRARE to have more than two years per female\n\nlet's start with one female\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 1\navg_csize <- 5\n\nlifespan <- 5\n\ngeneral_temp <- runif(lifespan, 2, 12)\n\ngeneral_temp_c <- general_temp - mean(general_temp)\n```\n:::\n\n\n## fecundity\n\n$$\n\\begin{align}\n\\text{eggs} &\\sim \\text{Poisson}(e^{\\beta_0 + \\beta_1*(x - \\bar{x})})\n\\end{align}\n$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\neffet_temp <- .1\n\none_bird <- tibble(year = 1:lifespan,\n       general_temp,\n       general_temp_c,\n       expected_clutch = log(avg_csize) + effet_temp * general_temp_c,\n       observed_clutch = rpois(n = length(year), \n                               lambda = exp(expected_clutch)))\n\none_bird\n```\n:::\n\n\nMake a simple model to measure\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(glm(observed_clutch ~ general_temp_c, data = one_bird))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\none_bird |> \n  ggplot(aes(x = general_temp, y = observed_clutch)) + \n  geom_point()\n```\n:::\n\n\n## Date of laying\n\nWhen do birds lay eggs?\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_dponte <- 138\n\neffet_temp_dponte <- -3\n\none_bird_dponte <- tibble(year = 1:lifespan,\n       general_temp,\n       general_temp_c,\n       expected_dponte = avg_dponte + effet_temp_dponte * general_temp_c,\n       observed_dponte = round(rnorm(n = length(year), \n                               mean = expected_dponte,\n                               sd = 5)))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\none_bird_dponte |> \n  ggplot(aes(x = general_temp, y= observed_dponte)) + \n  geom_point()\n\nsummary(lm(observed_dponte ~ general_temp_c, data = one_bird_dponte))\n```\n:::\n\n\n## combine the two\n\nBirds which lay earlier also lay larger eggs, possibly because they are High Quality Moms.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## population averages\npop_average_dponte <- 138\npop_average_csize <- 4\n\n## Effect of quality\nmom_quality <- 4\nquality_on_dponte <- 2\nquality_on_csize <- .2\n```\n:::\n\n\nlet's observe five years for the high-quality Mom:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nquality_effects <- tibble(\n  year = 1:lifespan,\n  mom_quality = mom_quality,\n  general_temp,\n  general_temp_c,\n  ## Effect of temperature -- does it depend on quality? let's say that it DOES (for now) \n  effet_temp_dponte_qual = -.7*mom_quality,\n  effet_temp_csize_qual = .1*log(mom_quality),\n  # csize\n  mom_avg_csize = log(pop_average_csize) +  quality_on_csize*log(mom_quality),\n  temp_avg_csize = exp(mom_avg_csize + effet_temp_csize_qual*general_temp_c),\n  # dponte\n  mom_avg_dponte = pop_average_dponte + quality_on_dponte*mom_quality,\n  temp_avg_dponte = mom_avg_dponte + effet_temp_dponte_qual*general_temp_c,\n  ## observations\n  obs_csize = rpois(n = length(year), lambda = temp_avg_csize),\n  obs_dponte = rnorm(n = length(year), mean = temp_avg_dponte, sd = 3) |> round()\n)\n```\n:::\n\n\nSome of these values are unreasonable! we can adjust later\n\n\n::: {.cell layout-ncol=\"2\"}\n\n```{.r .cell-code}\nquality_effects |> \n  ggplot(aes(x = general_temp, y = obs_csize)) + \n  geom_point()\n\nquality_effects |> \n  ggplot(aes(x = general_temp, y = obs_dponte)) + geom_point()\n```\n:::\n\n\n## Multiple females\n\nWe can repeat this process for multiple females at once! let's wrap it in a function to make it easier to work with.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimulate_many_moms\nmany_moms_temperature <- simulate_many_moms()\n```\n:::\n\n\nlet's plot it!\n\n\n::: {.cell layout-ncol=\"2\"}\n\n```{.r .cell-code}\nmany_moms_temperature |> \n  ggplot(aes(x = general_temp, y = obs_dponte)) + \n  geom_point()\n\nmany_moms_temperature |> \n  ggplot(aes(x = general_temp, y = obs_dponte, group = idF1)) + \n  stat_smooth(method = \"lm\", se = FALSE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmany_moms_temperature |> \n  ggplot(aes(x = general_temp, y = obs_csize)) + \n  geom_point()\n\nmany_moms_temperature |> \n  ggplot(aes(x = general_temp, y = obs_csize, group = idF1)) + \n  stat_smooth(method = \"lm\", se = FALSE)\n```\n:::\n\n\n## model in brms\n\nThe model above describes a situation where female swallows have some underlying trait (\"quality\"). This trait determines if this female will be above or below the rest of her population in two different outcomes: the timeing of her laying and the size of her clutch. This is a model structure that can't be easily fit in `lme4` at least as far as I know. However we can specify it in a very straightforward way using `brms`:\n\n\n::: {.cell}\n\n:::\n\n\n## fitness\n\n## notes\n\nvery small sample sizes per female -- experiment with this (2 years or more)\n\nThe data are 0-truncated: only nesting females are measured!\n\nI think it is particularly interesting that the data are already conditioned on reproduction. that is, females who fail to reproduce at all don't get included in the dataset. What effects could this have on our ability to detect interactions?\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}